#!/bin/bash

SDK_API=$1
ARCH=$2
shift 2

APK_BUILDER=${ANDROID_SDK_HOME}/tools/apkbuilder
AAPT=${ANDROID_SDK_HOME}/platform-tools/aapt
DEX=${ANDROID_SDK_HOME}/platform-tools/dx
JARSIGNER=$(which jarsigner 2> /dev/null)
ZIPALIGN=${ANDROID_SDK_HOME}/tools/zipalign

make $@ || exit $?

#make install DESTDIR=android || exit $?
test -d android/lib || { mkdir -p android/lib || exit $? ; }
cp @TCROOT@@PREFIX@lib/@PKGNAME_BASE@.so android/lib/

${AAPT} package -f \
	-M android/AndroidManifest.xml \
	-F @PKGNAME_BASE@.aapt \
	-I ${ANDROID_SDK_HOME}/platforms/${SDK_API}/android.jar \
	-S android/res || exit $?

${DEX} --dex \
	--output android/classes.dex \
	android/bin/classes \
	${ANDROID_SDK_HOME}/tools/support/annotations.jar || exit $?

${APK_BUILDER} @PKGNAME_BASE@.unsigned.apk \
	-u \
	-z @PKGNAME_BASE@.aapt \
	-nf android/libs || exit $?

${JARSIGNER} \
	-sigalg MD5withRSA -digestalg SHA1 \
	-keystore android/debug.keystore -keypass android -storepass android \
	-signedjar @PKGNAME_BASE@.debug.unaligned.apk \
	@PKGNAME_BASE@.unsigned.apk \
	androiddebugkey || exit $?

${ZIPALIGN} -v 4 @PKGNAME_BASE@.debug.unaligned.apk \
		@PKGNAME_BASE@.debug.apk || exit $?

#android update project -p . -s --target 1 || exit $?
#ant debug || exit $?

