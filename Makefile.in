
# We dont want to use built in rules. Those are ineffective and we
# can never know all of them, thus those can be unexpected as well.

.SUFFIXES:

MAKEFLAGS += --no-builtin-rules --no-builtin-variables
EMPTY=
COMMA=,
SPACE=$(EMPTY) $(EMPTY)
SHELL=bash

#
#	Configuration part
#

#DEFINES="-pipe -D_REENTRANT -DQT_WEBKIT -DQT_NO_DEBUG -DQT_SQL_LIB -DQT_GUI_LIB -DQT_CORE_LIB -DQT_SHARED -I/usr/share/qt4/mkspecs/linux-g++-64"

CFLAGS=@CFLAGS@
LDFLAGS=@LDFLAGS@
LIBS=@LIBS@
STATICS=@STATICS@
DEFINES+=@DEFINES@
INCLUDES=@INCLUDES@
CC=@CC@
CXX=@CXX@
CPP=@CPP@
LD=@LD@
STRIP=@STRIP@
OBJCOPY=@OBJCOPY@
MOC=@MOC@
RANLIB=@RANLIB@
PKGCONFIG=@PKGCONFIG@

#
# some tool
#

#cpp -dM /dev/null
COMPILE=$(CXX) -c $(CFLAGS) -MMD $(DEFINES) $(INCLUDES)
LINK=$(CXX) $(LDFLAGS) $^ $(STATICS) $(LIBS) -o $@
LINK_DYNAMIC=$(CXX) -shared -Wl,-as-needed -Bdynamic $(LDFLAGS) $^ $(STATICS) $(LIBS) \
	     -Wl,-soname,$(basename $(notdir $@)) -o $@
LINK_STATIC=ar cqs $@ $^

TESTDIR=tmp/@PKGNAME@/test/

tmp/src/datamodel/test/%.opp: src/datamodel/test/%.cpp
	@test -d $(dir $@) || mkdir -p $(dir $@)
	$(COMPILE) $(DATAMODEL_INCLUDES) -DTESTDIR=\"$(TESTDIR)\" -o $@ $<

tmp/src/sql/test/%.opp: src/sql/test/%.cpp
	@test -d $(dir $@) || mkdir -p $(dir $@)
	$(COMPILE) $(DATAMODEL_INCLUDES) $(SQL_INCLUDES) -DTESTDIR=\"$(TESTDIR)\" -o $@ $<

tmp/src/datamodel/%.opp: src/datamodel/%.cpp
	@test -d $(dir $@) || mkdir -p $(dir $@)
	$(COMPILE) $(DATAMODEL_INCLUDES) -o $@ $<

tmp/src/sql/%.opp: src/sql/%.cpp
	@test -d $(dir $@) || mkdir -p $(dir $@)
	$(COMPILE) $(DATAMODEL_INCLUDES) $(SQL_INCLUDES) -o $@ $<

tmp/src/qt/%.opp: src/qt/%.cpp
	@test -d $(dir $@) || mkdir -p $(dir $@)
	$(COMPILE) $(DATAMODEL_INCLUDES) $(SQL_INCLUDES) $(BUTLERQT_INCLUDES) -o $@ $<

@TCROOT@@PREFIX@include/@PKGNAME@/%.h: src/%.h
	@test -d $(dir $@) || mkdir -p $(dir $@)
	cp -pd $< $@

tmp/src/qt/moc/%.opp: tmp/src/qt/moc/%.cpp
	$(TARGETINFO)
	@test -d $(dir $@) || mkdir -p $(dir $@)
	$(COMPILE) $(DATAMODEL_INCLUDES) $(SQL_INCLUDES) $(BUTLERQT_INCLUDES) -o $@ $<
	$(TARGETFINISHED)

tmp/src/qt/moc/%.cpp: src/qt/%.h
	$(TARGETINFO)
	@test -d $(dir $@) || mkdir -p $(dir $@)
	$(MOC) -o $@ $<
	@touch $@
	$(TARGETFINISHED)

@TCROOT@@PREFIX@lib/% : \
		tmp/@TCROOT@@PREFIX@lib/%
	@test -d $(dir $@) || mkdir -p $(dir $@)
	cp $^ $@
	$(STRIP) --remove-section=.comment --remove-section=.note --strip-unneeded $@

@TCROOT@@PREFIX@lib/debug/@TCROOT@@PREFIX@lib/% : \
		tmp/@TCROOT@@PREFIX@lib/%
	@test -d $(dir $@) || mkdir -p $(dir $@)
	$(OBJCOPY) --only-keep-debug $^ $@

@TCROOT@@PREFIX@bin/% : \
		tmp/@TCROOT@@PREFIX@bin/%
	@test -d $(dir $@) || mkdir -p $(dir $@)
	cp $^ $@
	$(STRIP) --remove-section=.comment --remove-section=.note --strip-unneeded $@

@TCROOT@@PREFIX@lib/debug/@TCROOT@@PREFIX@bin/% : \
		tmp/@TCROOT@@PREFIX@bin/%
	@test -d $(dir $@) || mkdir -p $(dir $@)
	$(OBJCOPY) --only-keep-debug $^ $@

#
# build goals
#

TEST_BINARIES=\
#	tmp/bin/test-@PKGNAME_BASE@-sql-item@EXEC_POSTFIX@ \
#	tmp/bin/test-@PKGNAME_BASE@-sql-query@EXEC_POSTFIX@ \
#	tmp/bin/test-@PKGNAME_BASE@-sql-partner@EXEC_POSTFIX@ \
#	tmp/bin/test-@PKGNAME_BASE@-sql-tag@EXEC_POSTFIX@ \
#	tmp/bin/test-@PKGNAME_BASE@-sql-ware@EXEC_POSTFIX@

#
# temporary files
#

DATAMODEL_OBJECTS= 

DATAMODEL_INCLUDES=-Isrc/datamodel

STATIC_LIBDATAMODEL=tmp/@TCROOT@@PREFIX@lib/@PRJNAME@@VERSION_API@-datamodel.a

SQL_OBJECTS+= \
	tmp/src/sql/butler_sql_connection.opp \
	tmp/src/sql/butler_item_db.opp \
	tmp/src/sql/butler_queries_db.opp \
	tmp/src/sql/butler_partner_db.opp \
	tmp/src/sql/butler_company_db.opp \
	tmp/src/sql/butler_tag_db.opp \
	tmp/src/sql/butler_ware_db.opp

SQL_INCLUDES=-Isrc/sql

STATIC_LIBSQL=tmp/@TCROOT@@PREFIX@lib/@PRJNAME@@VERSION_API@-sql.a

BUTLERQT_OBJECTS+= \
	tmp/src/qt/main.opp \
	tmp/src/qt/butler_config.opp \
	tmp/src/qt/butler_databases.opp \
	tmp/src/qt/butler_mainview.opp \
	tmp/src/qt/butler_infoview.opp \
	tmp/src/qt/butler_tagsmodel.opp \
	tmp/src/qt/butler_partnersmodel.opp \
	tmp/src/qt/moc/butler_partnersmodel.opp \
	tmp/src/qt/butler_companymodel.opp \
	tmp/src/qt/moc/butler_companymodel.opp \
	tmp/src/qt/butler_waresmodel.opp \
	tmp/src/qt/butler_warecategoriesmodel.opp \
	tmp/src/qt/butler_itemsmodel.opp \
	tmp/src/qt/butler_custommodel.opp \
	tmp/src/qt/butler_shoppingmodel.opp \
	tmp/src/qt/butler_queriesmodel.opp \
	tmp/src/qt/butler_databasesmodel.opp \
	tmp/src/qt/butler_customview.opp \
	tmp/src/qt/butler_databasesview.opp \
	tmp/src/qt/butler_edititemview.opp \
	tmp/src/qt/butler_application.opp \
	tmp/src/qt/butler_buyitemview.opp \
	tmp/src/qt/butler_editpartnerview.opp \
	tmp/src/qt/butler_editcompanyview.opp \
	tmp/src/qt/butler_editdbdescview.opp \
	tmp/src/qt/butler_edittagview.opp \
	tmp/src/qt/butler_editwareview.opp \
	tmp/src/qt/butler_newitemview.opp \
	tmp/src/qt/butler_queryoptionsview.opp \
	tmp/src/qt/butler_shoppingview.opp \
	tmp/src/qt/butler_partnersview.opp \
	tmp/src/qt/butler_companyview.opp \
	tmp/src/qt/butler_tagfilterview.opp \
	tmp/src/qt/butler_tagsview.opp \
	tmp/src/qt/butler_tagwidget.opp \
	tmp/src/qt/butler_waresview.opp \
	tmp/src/qt/butler_pannview.opp \
	tmp/src/qt/butler_widgets.opp \
	tmp/src/qt/butler_texts.opp \
	tmp/src/qt/moc/butler_config.opp \
	tmp/src/qt/moc/butler_databases.opp \
	tmp/src/qt/moc/butler_mainview.opp \
	tmp/src/qt/moc/butler_infoview.opp \
	tmp/src/qt/moc/butler_tagsmodel.opp \
	tmp/src/qt/moc/butler_waresmodel.opp \
	tmp/src/qt/moc/butler_warecategoriesmodel.opp \
	tmp/src/qt/moc/butler_itemsmodel.opp \
	tmp/src/qt/moc/butler_custommodel.opp \
	tmp/src/qt/moc/butler_shoppingmodel.opp \
	tmp/src/qt/moc/butler_queriesmodel.opp \
	tmp/src/qt/moc/butler_databasesmodel.opp \
	tmp/src/qt/moc/butler_customview.opp \
	tmp/src/qt/moc/butler_databasesview.opp \
	tmp/src/qt/moc/butler_newitemview.opp \
	tmp/src/qt/moc/butler_application.opp \
	tmp/src/qt/moc/butler_buyitemview.opp \
	tmp/src/qt/moc/butler_editpartnerview.opp \
	tmp/src/qt/moc/butler_editcompanyview.opp \
	tmp/src/qt/moc/butler_editdbdescview.opp \
	tmp/src/qt/moc/butler_edittagview.opp \
	tmp/src/qt/moc/butler_editwareview.opp \
	tmp/src/qt/moc/butler_edititemview.opp \
	tmp/src/qt/moc/butler_queryoptionsview.opp \
	tmp/src/qt/moc/butler_shoppingview.opp \
	tmp/src/qt/moc/butler_partnersview.opp \
	tmp/src/qt/moc/butler_companyview.opp \
	tmp/src/qt/moc/butler_tagfilterview.opp \
	tmp/src/qt/moc/butler_tagsview.opp \
	tmp/src/qt/moc/butler_tagwidget.opp \
	tmp/src/qt/moc/butler_waresview.opp \
	tmp/src/qt/moc/butler_pannview.opp \
	tmp/src/qt/moc/butler_widgets.opp \
	tmp/src/qt/butler_kineticscroller.opp \
	tmp/src/qt/moc/butler_kineticscroller.opp \
	tmp/src/qt/butler_statsview.opp \
	tmp/src/qt/moc/butler_statsview.opp

BUTLERQT_INCLUDES=-Isrc/qt

.PRECIOUS: $(BUTLERQT_OBJECTS)

BUTLER_IMAGES+=\
	$(ICONS_DIR)/copyright \
	$(ICONS_DIR)/accounting.png \
	$(ICONS_DIR)/analitics.png \
	$(ICONS_DIR)/add.png \
	$(ICONS_DIR)/buy.png \
	$(ICONS_DIR)/delete.png \
	$(ICONS_DIR)/edit.png \
	$(ICONS_DIR)/query.png \
	$(ICONS_DIR)/shopping.png \
	$(ICONS_DIR)/tag.png \
	$(ICONS_DIR)/trash.png \
	$(ICONS_DIR)/cancel.png \
	$(ICONS_DIR)/ok.png \
	$(ICONS_DIR)/ware.png \
	$(ICONS_DIR)/info.png \
	$(ICONS_DIR)/warning.png \
	$(ICONS_DIR)/list.png \
	$(ICONS_DIR)/left.png \
	$(ICONS_DIR)/right.png \
	$(ICONS_DIR)/tick.png \
	$(ICONS_DIR)/partner.png \
	$(ICONS_DIR)/company.png \
	$(ICONS_DIR)/refresh.png \
	$(ICONS_DIR)/statistics.png \
	$(ICONS_DIR)/comboarrowdown.png \
	$(ICONS_DIR)/comboarrowup.png \
	$(ICONS_DIR)/calendar.png \
	$(ICONS_DIR)/databases.png \
	$(ICONS_DIR)/use.png \
	$(ICONS_DIR)/butler.png

#
# main rules
#

build: \
	$(STATIC_LIBDATAMODEL) \
	$(STATIC_LIBSQL) \
	$(BUTLER_IMAGES) \
	$(BUILD_DEPS) \
	$(CSS_DIR)/application.css \
	$(TRANSLATIONS_DIR)/en.qm \
	$(TRANSLATIONS_DIR)/hu.qm

clean:
	test "x" = "x$(shell find . | grep \\~$$)" || rm $(shell find . | grep \\~$$)
	test "x" = "x$(shell find . | grep \\.swp$$)" || rm $(shell find . | grep \\.swp$$)
	test "x" = "x$(shell find . | grep \\.log$$)" || rm $(shell find . | grep \\.log$$)
	! test -d tmp || rm -fr tmp
	! test -d @TCROOT@@PREFIX@bin || rm -fr @TCROOT@@PREFIX@bin
	! test -d @TCROOT@@PREFIX@lib || rm -fr @TCROOT@@PREFIX@lib
	! test -d @TCROOT@@PREFIX@share || rm -fr @TCROOT@@PREFIX@share
	! test -d @TCROOT@@PREFIX@test || rm -fr @TCROOT@@PREFIX@test
	! test -d @TCROOT@@PREFIX@include || rm -fr @TCROOT@@PREFIX@include
	test "x" = "x@TCROOT@@PREFIX@" || { ! test -d @TCROOT@@PREFIX@ || rmdir @TCROOT@@PREFIX@ ; }
	! test -e Makefile || rm Makefile
	! test -e doxyfile || rm doxyfile

install: build
	test -d $(DESTDIR) || mkdir -p $(DESTDIR)
	test -d $(DESTDIR)/@PREFIX@ || mkdir -p $(DESTDIR)/@PREFIX@
	cp -pdr @TCROOT@@PREFIX@share $(DESTDIR)/@PREFIX@share
	cp -pdr @TCROOT@@PREFIX@bin $(DESTDIR)/@PREFIX@bin

check: $(TEST_BINARIES)
	@let RET=0; \
	mkdir -p $(TESTDIR); \
	for t in $(TEST_BINARIES); do \
		$$t || let RET=$$?; \
	done; \
	test $$RET -eq 0 || { \
		echo -e "\e[31m"; \
		echo "There was some failure during testing !"; \
		echo -e "\e[0m"; \
		false ; \
	}

@TCROOT@@DOC_DIR@/html/index.html: $(HEADERS)
	@test -d $(dir $@) || mkdir -p $(dir $@)
	doxygen - < doxyfile

doxygen: @TCROOT@@DOC_DIR@/html/index.html

FORCE:

#
#	build rules
#

$(STATIC_LIBDATAMODEL): \
		$(DATAMODEL_OBJECTS)
	test -d $(dir $@) || mkdir -p $(dir $@)
	$(LINK_STATIC)
	$(RANLIB) $@

$(STATIC_LIBSQL): \
		$(SQL_OBJECTS)
	test -d $(dir $@) || mkdir -p $(dir $@)
	$(LINK_STATIC)
	$(RANLIB) $@

tmp/@TCROOT@@PREFIX@lib/lib@PKGNAME_BASE@.so: \
		$(BUTLERQT_OBJECTS) \
		$(STATIC_LIBDATAMODEL) \
		$(STATIC_LIBSQL)
	@test -d $(dir $@) || mkdir -p $(dir $@)
	$(LINK_DYNAMIC)

tmp/@TCROOT@@PREFIX@bin/@PKGNAME_BASE@@EXEC_POSTFIX@: \
		$(BUTLERQT_OBJECTS) \
		$(STATIC_LIBDATAMODEL) \
		$(STATIC_LIBSQL)
	test -d $(dir $@) || mkdir -p $(dir $@)
	$(LINK)

@TCROOT@tmp/bin/test-@PKGNAME_BASE@-datamodel-% : \
		tmp/src/datamodel/test/%.opp \
		$(STATIC_LIBDATAMODEL)
	@test -d $(dir $@) || mkdir -p $(dir $@)
	$(LINK)

@TCROOT@tmp/bin/test-@PKGNAME_BASE@-sql-% : \
		tmp/src/sql/test/%.opp \
		$(STATIC_LIBSQL) \
		$(STATIC_LIBDATAMODEL)
	@test -d $(dir $@) || mkdir -p $(dir $@)
	$(LINK)

$(ICONS_DIR)/%.png: \
		share/icons/%.png
	@test -d $(dir $@) || mkdir -p $(dir $@)
	cp $< $@

$(CSS_DIR)/%.css: \
		share/css/%.css
	@test -d $(dir $@) || mkdir -p $(dir $@)
	cp $< $@

$(TRANSLATIONS_DIR)/%.qm: \
		share/translations/%.qm
	@test -d $(dir $@) || mkdir -p $(dir $@)
	cp $< $@

$(ICONS_DIR)/copyright: \
		share/icons/copyright
	@test -d $(dir $@) || mkdir -p $(dir $@)
	cp $< $@

-include $(DATAMODEL_OBJECTS:.opp=.d)
-include $(SQL_OBJECTS:.opp=.d)
-include $(BUTLERQT_OBJECTS:.opp=.d)

